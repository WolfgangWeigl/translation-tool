<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IdeaL | Translation Tool</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

  <!-- Bootstrap Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css"
    rel="stylesheet">

  <!-- Favicon -->
  <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Bootstrap JS Bundle (with Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"
    integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO"
    crossorigin="anonymous"></script>
</head>

<body>
  <nav class='navbar navbar-expand-lg bg-body-tertiary'>
    <div class='container-fluid'>
      <a class='navbar-brand user-select-none' href='#'>
        <img src='{{ url_for("static", filename="images/navbar-icon.svg") }}' alt='Logo' width='30' height='30'
          class='d-inline-block align-text-top'>
        IdeaL | Translation Tool
      </a>

      <button class='navbar-toggler' type='button' data-bs-toggle='collapse' data-bs-target='#navbarNavAltMarkup'
        aria-controls='navbarNavAltMarkup' aria-expanded='false' aria-label='Toggle navigation'>
        <span class='navbar-toggler-icon'></span>
      </button>

      <div class='collapse navbar-collapse' id='navbarNavAltMarkup'>
        <div class='navbar-nav'>
          <a class='nav-link active' aria-current='page' href='#'>Home</a>
          <a class='nav-link' href='#'>Lorem</a>
          <a class='nav-link' href='#'>Ipsum</a>
          <a class='nav-link disabled' aria-disabled='true'>Disabled</a>
        </div>
      </div>
    </div>
  </nav>

  <main>
    <div class='container mt-5 p-3 custom-form bg-light border rounded shadow-sm'>
      <h2 class='text-center h2 user-select-none'>Translate your MBZ File</h2>
      <div class='text-center text-muted user-select-none'>Upload an MBZ file, specify the original language, and choose the target language to translate it into.</div>

      <!-- Form -->
      <form id='upload-form'>

        <!-- File Selection -->
        <div class='input-group mb-3 mt-3 position-relative'>
          <input class='position-absolute opacity-0 w-100 h-100' type='file' id='fileinput' name='file-input'
            accept='.mbz' required>
          <label class='form-control w-25 btn btn-outline-primary user-select-none' for='fileinput'
            style='border-radius: 0.375em 0 0 0.375em;'>Select MBZ File</label>
          <div class='form-control w-75 text-muted user-select-none' id='filename'>No file selected</div>
        </div>

        <!-- Source Language Selection -->
        <div class='form-floating mb-3'>
          <select class='form-select' id='originalLanguage' name='original-language' required>
            <option value='' disabled selected>---</option>
            {% for lang in langs %}
              <option value='{{ lang["code"] }}'>{{ lang["name"] }}</option>
            {% endfor %}
          </select>
          <label for='originalLanguage' class='form-label'>Original Language</label>
        </div>

        <!-- Target Language Selection -->
        <div class='form-floating mb-3'>
          <select class='form-select' id='targetLanguage' name='target-language' required disabled>
            <option value='' disabled selected>---</option>
          </select>
          <label for='targetLanguage' class='form-label'>Target Language</label>
        </div>

        <!-- Translation Type Selection -->
        <div class='d-flex align-items-center'>
          <small class='me-4 text-muted user-select-none'>Translation type:</small>
          <div>
            <div class='form-check'>
              <input class='form-check-input' type='radio' name='translationType' id='singlelang' value='single'
                required checked>
              <label class='form-check-label user-select-none' for='singlelang'>One Language</label>
            </div>
            <div class='form-check'>
              <input class='form-check-input' type='radio' name='translationType' id='multilang' value='multi' required
                disabled>
              <label class='form-check-label user-select-none' for='multilang'>Multiple Languages</label>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class='text-center mt-4'>
          <button id='translateBtn' type='submit' class='btn btn-outline-primary'>
            <i class='bi bi-translate me-2'></i>Translate
          </button>
        </div>

      </form>
    </div>

    <!-- Progress Bars -->
    <div id='progress-bars' class='container mt-3 mb-3' hidden>
      <div class='d-flex align-items-center mb-2 border border-primary rounded'>
        <small class='w-25 text-center text-muted user-select-none' >Upload</small>
        <div class='progress flex-grow-1' role='progressbar' style="height: 21px;">
          <div id='progress-bar-1' class='progress-bar progress-bar-striped progress-bar-animated' style='width: 0%'>0%</div>
        </div>
      </div>

      <div class='d-flex align-items-center mb-2 border border-primary rounded'>
        <small class='w-25 text-center text-muted user-select-none'>Unpacking</small>
        <div class='progress flex-grow-1' role='progressbar' style="height: 21px;">
          <div id='progress-bar-2' class='progress-bar progress-bar-striped progress-bar-animated' style='width: 0%'>0%</div>
        </div>
      </div>
    </div>

    <!-- Download -->
    {% if download %}
    <div id='downloadForm' class='container mt-4 p-3 bg-light border rounded shadow-sm d-flex align-items-center'>
      <i class='bi bi-file-earmark-zip fs-3 text-primary me-2'></i>
      <div class='flex-grow-1'>
        <p class='mb-0 fw-bold user-select-none'>{{ download.file_name }}</p>
        <small class='text-muted'>
          Type: {{ download.file_type }} <br>
          From {{ download.source }} to {{ download.target }}
        </small>
      </div>
      <button type='button' class='btn btn-outline-primary ms-5'>
        <i class='bi bi-download me-2'></i>Download
      </button>
    </div>
    {% endif %}
  </main>

  <script>
    document.getElementById('fileinput').addEventListener('change', e => {
      document.getElementById('filename').textContent = e.target.files[0]?.name || 'No file selected';
    });
  </script>

  <script>
  document.getElementById("originalLanguage").addEventListener("change", function() {
    let target = document.getElementById("targetLanguage"); 

    if(this.value !== "") {
      target.disabled = false;
    } else {
      target.disabled = true;
    }
  });

  source.addEventListener("change")

  </script>

  <script>
    const socket = io();

    // Handle Target Limit on selected Source Language
    document.getElementById('originalLanguage').addEventListener('change', function () {
      const langs = {{ langs | tojson }};

      const srcLang = this.value;
      const destLang = document.getElementById('targetLanguage');
      destLang.innerHTML = "<option value='' disabled selected>---</option>"

      const language = langs.find(l => l.code === srcLang);

      if (language) {
        language.targets.forEach(target => {
          const option = document.createElement('option');
          option.value = target;
          option.textContent = langs.find(l => l.code === target).name;
          destLang.appendChild(option);
        });
      }
    });

    // Handle form submission
    document.getElementById('upload-form').addEventListener('submit', function (event) {
      event.preventDefault();

      // Show Progress Bars
      document.getElementById('progress-bars').removeAttribute('hidden');

      // Upload
      const file = document.getElementById('fileinput').files[0];

      socket.emit('upload', {
        fileName: file.name,
        fileData: file,
        src: document.getElementById('originalLanguage').value,
        dest: document.getElementById('targetLanguage').value
      });

    });

    // Listen for upload progress
    socket.on('upload_progress', (data) => {
      const progressBar = document.getElementById('progress-bar-1');
      progressBar.textContent = `${data.progress.toFixed(2)}%`;
      progressBar.style.width = `${data.progress}%`;
      if (data.finished) progressBar.classList.remove('progress-bar-animated');
      console.debug(data);
    });

    // Listen for extraction progress
    socket.on('extraction_progress', (data) => {
      const progressBar = document.getElementById('progress-bar-2');
      progressBar.textContent = `${data.progress.toFixed(2)}%`;
      progressBar.style.width = `${data.progress}%`;
      if (data.finished) progressBar.classList.remove('progress-bar-animated');
    });
  </script>

</body>

</html>